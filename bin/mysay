#!/bin/bash
# mysay - ElevenLabs TTS CLI for agent-to-human communication
# Uses different voices based on mood/situation + emoji screen overlays!
#
# Project: https://github.com/zuriel/mysay
# Docs: ./docs/HANDOFF.md

set -e

# ============================================================================
# CONFIGURATION - Override these in ~/.mysay or ~/.config/mysay/config
# ============================================================================

# Default Voice IDs (ElevenLabs)
# These are Zuriel's custom voices - you may need to use your own
VOICE_DONE="${VOICE_DONE:-4tRn1lSkEn13EVTuqb0g}"       # üéâ Cheerleader - Task Complete
VOICE_QUESTION="${VOICE_QUESTION:-YOq2y2Up4RgXP2HyXjE5}" # ‚ùì Philosopher - Question/Help
VOICE_START="${VOICE_START:-si0svtk05vPEuvwAW93c}"     # üöÄ Rocket - Starting Work
VOICE_ERROR="${VOICE_ERROR:-flHkNRp1BlvT73UL6gyz}"     # üêõ Dramatic - Error/Problem
VOICE_IDEA="${VOICE_IDEA:-weA4Q36twV5kwSaTEL0Q}"       # üí° Mentor - Idea/Suggestion
VOICE_HI="${VOICE_HI:-Z7RrOqZFTyLpIlzCgfsp}"           # üëã Friendly - Greeting/Goodbye
VOICE_HEBREW="${VOICE_HEBREW:-4H1tDNxkPIwJmpnc3x2E}"   # üáÆüá± Default Hebrew
VOICE_ENGLISH="${VOICE_ENGLISH:-IdfCM5gzYj8bcGLVUBAH}" # üá∫üá∏ Default English

# Emoji mappings for each mood (used by emoji-overlay)
EMOJI_DONE="üéâ"
EMOJI_QUESTION="‚ùì"
EMOJI_START="üöÄ"
EMOJI_ERROR="üêõ"
EMOJI_IDEA="üí°"
EMOJI_HI="üëã"
EMOJI_HEBREW="üáÆüá±"
EMOJI_ENGLISH="üá∫üá∏"

# Defaults
VOICE_ID="$VOICE_HEBREW"
EMOJI="$EMOJI_HEBREW"
SHOW_EMOJI=true
MODEL_ID="${MODEL_ID:-eleven_v3}"

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# ============================================================================
# LOAD CONFIGURATION
# ============================================================================

# 1. Try ~/.mysay (simple format)
if [ -f "$HOME/.mysay" ]; then
  source "$HOME/.mysay"
fi

# 2. Try ~/.config/mysay/config (XDG format)
if [ -f "$HOME/.config/mysay/config" ]; then
  source "$HOME/.config/mysay/config"
fi

# 3. Try project .env.local
if [ -f "$PROJECT_DIR/.env.local" ]; then
  export $(grep -E '^[A-Z_]+=' "$PROJECT_DIR/.env.local" 2>/dev/null | xargs)
fi

# Validate API key
if [ -z "$ELEVENLABS_API_KEY" ]; then
  echo "‚ùå Error: ELEVENLABS_API_KEY not set"
  echo ""
  echo "Set it by creating ~/.mysay:"
  echo "  echo 'ELEVENLABS_API_KEY=sk_...' > ~/.mysay"
  echo ""
  echo "Or run: $PROJECT_DIR/install.sh"
  exit 1
fi

# ============================================================================
# ARGUMENT PARSING
# ============================================================================

TEXT=""
CUSTOM_EMOJI=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --done|-d)
      VOICE_ID="$VOICE_DONE"
      EMOJI="$EMOJI_DONE"
      shift
      ;;
    --question|-q)
      VOICE_ID="$VOICE_QUESTION"
      EMOJI="$EMOJI_QUESTION"
      shift
      ;;
    --start|-s)
      VOICE_ID="$VOICE_START"
      EMOJI="$EMOJI_START"
      shift
      ;;
    --error|-e)
      VOICE_ID="$VOICE_ERROR"
      EMOJI="$EMOJI_ERROR"
      shift
      ;;
    --idea|-i)
      VOICE_ID="$VOICE_IDEA"
      EMOJI="$EMOJI_IDEA"
      shift
      ;;
    --hi|-h)
      VOICE_ID="$VOICE_HI"
      EMOJI="$EMOJI_HI"
      shift
      ;;
    --en)
      VOICE_ID="$VOICE_ENGLISH"
      EMOJI="$EMOJI_ENGLISH"
      shift
      ;;
    --emoji)
      CUSTOM_EMOJI="$2"
      shift 2
      ;;
    --no-emoji)
      SHOW_EMOJI=false
      shift
      ;;
    --voice)
      VOICE_ID="$2"
      shift 2
      ;;
    --help)
      cat << 'EOF'
mysay - ElevenLabs TTS for agent-to-human communication with emoji overlays!

Usage: mysay [OPTIONS] "text to speak"

Voice/Mood Options:
  --done, -d       üéâ Cheerleader voice (task complete)
  --question, -q   ‚ùì Philosopher voice (need help)
  --start, -s      üöÄ Rocket voice (starting work)
  --error, -e      üêõ Dramatic voice (problem)
  --idea, -i       üí° Mentor voice (suggestion)
  --hi, -h         üëã Friendly voice (greeting)
  --en             üá∫üá∏ English voice
  (default)        üáÆüá± Hebrew voice

Emoji Options:
  --emoji [char]   Override the default emoji (e.g., --emoji ‚ù§Ô∏è)
  --no-emoji       Disable emoji screen overlay

Advanced Options:
  --voice [id]     Use custom ElevenLabs voice ID

Examples:
  mysay --done "◊°◊ô◊ô◊û◊™◊ô ◊ê◊™ ◊î◊û◊©◊ô◊û◊î!"
  mysay --error "◊ô◊© ◊ë◊¢◊ô◊î ◊ë◊ß◊ï◊ì"
  mysay --emoji üî• "◊ñ◊î ◊ó◊ù!"
  mysay --en --emoji üöÄ "Launching now!"
  mysay --done "[excited] ◊î÷∑◊û÷¥÷º◊©÷¥◊Å◊ô◊û÷∏◊î ◊î◊ï÷º◊©÷∞◊Å◊ú÷∞◊û÷∏◊î!"

Environment Variables:
  ELEVENLABS_API_KEY    Your ElevenLabs API key (required)
  VOICE_DONE            Voice ID for --done
  VOICE_ERROR           Voice ID for --error
  ... etc (see ~/.mysay.example)

Config Files (loaded in order):
  ~/.mysay
  ~/.config/mysay/config
  ./.env.local
EOF
      exit 0
      ;;
    --version)
      echo "mysay v1.0.0"
      exit 0
      ;;
    *)
      TEXT="$1"
      shift
      ;;
  esac
done

if [ -z "$TEXT" ]; then
  echo "‚ùå Error: No text provided"
  echo "Usage: mysay [--done|--question|--start|--error|--idea|--hi|--en] \"text\""
  echo "       mysay --help for more options"
  exit 1
fi

# Apply custom emoji if provided
if [ -n "$CUSTOM_EMOJI" ]; then
  EMOJI="$CUSTOM_EMOJI"
fi


# ============================================================================
# EMOJI OVERLAY (non-blocking)
# ============================================================================

if [ "$SHOW_EMOJI" = true ] && [ -f "$SCRIPT_DIR/emoji-pop" ]; then
  "$SCRIPT_DIR/emoji-pop" "$EMOJI" 15 3 &
fi

# ============================================================================
# GOOGLE SHEETS LOGGING (optional, non-blocking)
# ============================================================================

SA_FILE="${MYSAY_SA_FILE:-$HOME/.config/mysay/google-sheets-sa.json}"
SHEET_ID="${MYSAY_SHEET_ID:-}"

if [ -n "$SHEET_ID" ] && [ -f "$SA_FILE" ]; then
  python3 - "$SA_FILE" "$SHEET_ID" "$TEXT" "$VOICE_ID" "$EMOJI" << 'PYEOF' &
import sys, gspread
from google.oauth2.service_account import Credentials
from datetime import datetime
sa_file, sheet_id, text, voice_id, mood = sys.argv[1:6]
try:
    creds = Credentials.from_service_account_file(sa_file, scopes=['https://www.googleapis.com/auth/spreadsheets'])
    gc = gspread.authorize(creds)
    sh = gc.open_by_key(sheet_id)
    ws = sh.sheet1
    if ws.row_count == 0 or ws.acell('A1').value is None:
        ws.append_row(['Timestamp', 'Text', 'Voice ID', 'Mood', 'Audio URL', 'Rating', 'Notes'])
    ws.append_row([datetime.utcnow().isoformat(), text, voice_id, mood, '', '', ''])
except Exception:
    pass  # Silent fail - don't block TTS
PYEOF
fi

# ============================================================================
# TEXT-TO-SPEECH (ElevenLabs)
# ============================================================================

AUDIO_FILE="/tmp/mysay_$(date +%s).mp3"

# Call ElevenLabs API
HTTP_CODE=$(curl -s -w "%{http_code}" \
  "https://api.elevenlabs.io/v1/text-to-speech/$VOICE_ID" \
  -H "xi-api-key: $ELEVENLABS_API_KEY" \
  -H "Content-Type: application/json" \
  -d "{
    \"text\": \"$TEXT\",
    \"model_id\": \"$MODEL_ID\",
    \"voice_settings\": {\"stability\": 0.5, \"similarity_boost\": 0.75}
  }" \
  --output "$AUDIO_FILE")

# Check response
if [ "$HTTP_CODE" != "200" ]; then
  echo "‚ùå Error: ElevenLabs API returned HTTP $HTTP_CODE"
  cat "$AUDIO_FILE" 2>/dev/null  # Show error message
  rm -f "$AUDIO_FILE"
  exit 1
fi

# Play audio
if [ -s "$AUDIO_FILE" ]; then
  # macOS
  if command -v afplay &>/dev/null; then
    afplay "$AUDIO_FILE"
  # Linux
  elif command -v mpv &>/dev/null; then
    mpv --no-video "$AUDIO_FILE" 2>/dev/null
  elif command -v aplay &>/dev/null; then
    aplay "$AUDIO_FILE" 2>/dev/null
  else
    echo "‚ùå Error: No audio player found (tried: afplay, mpv, aplay)"
    exit 1
  fi
  rm -f "$AUDIO_FILE"
else
  echo "‚ùå Error: Failed to generate audio"
  rm -f "$AUDIO_FILE"
  exit 1
fi
